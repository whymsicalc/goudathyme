{% extends 'base.html' %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link href="../static/table.css" rel="stylesheet">
{% endblock %}

{% block content %}
<h1>Hello there, {{user.fname}}!</h1>
<div class="container-fluid">
    <div class="row">
        <div class="col-8" style="overflow-x:auto;">
            <h4>This is what you have logged in your kitchen so far:</h4>
            <form id="update-kitchen" action="/update-kitchen" method="POST">
              <table>
                  <thead>
                      <tr>
                          <th>Ingredient</th>
                          <th>Expiration Date</th>
                          <th>Running Low</th>
                          <th>Notes</th>
                          <th>Actions</th>
                      </tr>
                  </thead>
                  <tbody id="current-ings">
                        {% for item in user.items %}                
                            <tr>
                                <td>{{item.ingredients.name}}</td>
                                <td>{{item.expiration_date}}</td>
                                <td>{{item.running_low}}</td>
                                <td>{{item.notes}}</td>
                                <td>
                                  <button type="submit" class="add" title="Add" data-toggle="tooltip" data-placement="top"><i class="material-icons">&#xE03B;</i></button>
                                  <a class="edit" title="Edit" data-toggle="tooltip" data-placement="top"><i class="material-icons">&#xE254;</i></a>
                                  <a class="delete" title="Delete" data-toggle="tooltip" data-placement="top"><i class="material-icons">&#xE872;</i></a>
                                </td>
                            </tr>
                        {% endfor %}
                  </tbody>
              </table>
            </form>
        </div>

        <div class="col-4">
            <h4>What else is in your kitchen?</h4>
            <form id="add-to-kitchen" action="/add-to-kitchen" method="POST">
                <select class="new-ingredient form-control" name="ingredients" multiple="multiple" id="to-add">
                    {% for ingredient in ingredients %}
                    <option value={{ingredient.ing_id}}>{{ingredient.name}}</option>
                    {% endfor %}
                </select>

                <button type="submit">Add Ingredient!</button>
            </form><br>
            <!-- <script src="JAVASCRIPT LOCATION"></script>
             -->
             <script>
                $('#add-to-kitchen').on('submit', (evt) => {
                  evt.preventDefault();

                  const formInputs = $(`#to-add`).serialize();

                  $.post('/add-to-kitchen', formInputs, (res) => {
                    for (const item of res) {
                      let expiration = "None";
                      if (item.expiration_date) {
                        expiration = item.expiration_date
                      };
                      let low = "None";
                      if (item.running_low) {
                        low = item.running_low
                      };
                      let notes = "None";
                      if (item.notes) {
                        const notes = item.notes
                      };
                      $('#current-ings').append(
                          `<tr>
                              <td>${item.ingredient_name}</td>
                              <td>${expiration}</td>
                              <td>${low}</td>
                              <td>${notes}</td>
                              <td>
                                <a class="add" title="Add" data-toggle="tooltip" data-placement="top"><i class="material-icons">&#xE03B;</i></a>
                                <a class="edit" title="Edit" data-toggle="tooltip" data-placement="top"><i class="material-icons">&#xE254;</i></a>
                                <a class="delete" title="Delete" data-toggle="tooltip" data-placement="top"><i class="material-icons">&#xE872;</i></a>
                              </td>
                          </tr>`
                          );
                  }});
                  // Clear select box each time user adds ingredient
                  $(".new-ingredient").val('').trigger('change');
                });
                // Let user add new ingredient (to their list and to ingredients table)
              $(document).ready(function() {
                  $('.new-ingredient').select2({
                    // Allows user to create new option if it isn't in options
                    tags: true,
                    placeholder: "Enter an Ingredient",
                    // Creates new tag when "," is entered
                    tokenSeparators: [','],
                //       // createTag: function (params) {
                //       //   // Don't offset to create a tag if there is no @ symbol
                //       //   // if (params.term.indexOf('@') === -1) {
                //       //     // Return null to disable tag creation
                //       //     // return null;
                //       //   // }
                //       //   console.log(params)
                //       //   return {
                //       //     id: params.term,
                //       //     text: params.term
                //       //   }
                //       // }
                    createTag: function (params) {
                      const term = $.trim(params.term);

                      if (term === '') {
                        return null;
                      }

                      return {
                        id: term,
                        text: term,
                        newTag: true // add additional parameters
                      }
                    }
                });
                // $('submit').on('click', (evt) => {
              });
            $(document).ready(function () {
              $('[data-toggle="tooltip"]').tooltip()
            })
            $(document).ready(function(){
                // Edit row on edit button click
                $(document).on("click", ".edit", function(){
                    $(this).parents("tr").find("td:nth-child(2)").each(function(){
                        $(this).html('<input type="date" id="date" class="form-control" value="' + $(this).text() + '">');
                    });
                    $(this).parents("tr").find("td:nth-child(3)").each(function(){
                        $(this).html('<input type="checkbox" id="low" value="' + $(this).text() + '" >');
                    });
                    $(this).parents("tr").find("td:nth-child(4)").each(function(){
                        $(this).html('<input type="text" id="notes" class="form-control" value="' + $(this).text() + '">');
                    });     
                    $(this).parents("tr").find(".add, .edit").toggle();
                });
                // Delete row on delete button click
                $(document).on("click", ".delete", function(){
                    $(this).parents("tr").remove();
                });
            });
            // $('#update-kitchen').on('submit', (evt) => {
            //       evt.preventDefault();

            //        const formInputs = {
            //           'date': $('#date').val(),
            //           'low': $('#low').val(),
            //           'notes': $('notes').val()
            //         };

            //       $.post('/update-kitchen', formInputs, (res) => {
            //         for (const item of res) {
                      
            //       }});
            </script>
            </div>
    </div>
</div>
{% endblock %}
